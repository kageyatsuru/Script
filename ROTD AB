local player = game:GetService("Players").LocalPlayer
local runService = game:GetService("RunService")
local uis = game:GetService("UserInputService")
local camera = workspace.CurrentCamera

-- SETTINGS
local isEnabled = false
local smoothing = 0.4 -- Slightly lower for better FPS
local fovRadius = 150
local maxDistance = 600

-- UI SETUP (High Priority)
local screenGui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
screenGui.Name = "Stable_Aimbot"
screenGui.DisplayOrder = 999 -- Ensures it stays on top
screenGui.ResetOnSpawn = false

local container = Instance.new("Frame", screenGui)
container.Size = UDim2.new(0, 100, 0, 50)
container.Position = UDim2.new(0.5, -50, 0.1, 0) -- Top middle
container.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
container.Active = true
container.Draggable = true -- Simplest way to move UI

local toggleBtn = Instance.new("TextButton", container)
toggleBtn.Size = UDim2.new(1, 0, 1, 0)
toggleBtn.Text = "AIM: OFF"
toggleBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
toggleBtn.TextColor3 = Color3.new(1,1,1)

-- FOV CIRCLE (Optimized)
local fovCircle = Drawing.new("Circle")
fovCircle.Thickness = 1
fovCircle.Color = Color3.new(0, 1, 0)
fovCircle.Visible = false

-- TOGGLE ACTION
toggleBtn.MouseButton1Click:Connect(function()
    isEnabled = not isEnabled
    toggleBtn.Text = isEnabled and "AIM: ON" or "AIM: OFF"
    toggleBtn.BackgroundColor3 = isEnabled and Color3.fromRGB(50, 200, 50) or Color3.fromRGB(200, 50, 50)
    fovCircle.Visible = isEnabled
end)

-- GET TARGET FUNCTION (Run only when needed)
local function getTarget()
    local center = Vector2.new(camera.ViewportSize.X / 2, camera.ViewportSize.Y / 2)
    local closest, minScore = nil, fovRadius
    local entities = workspace:FindFirstChild("Entity")
    
    if entities then
        for _, v in ipairs(entities:GetChildren()) do
            local head = v:FindFirstChild("Head")
            local hum = v:FindFirstChild("Zombie") or v:FindFirstChildOfClass("Humanoid")
            
            if head and hum and hum.Health > 0 then
                local pos, onScreen = camera:WorldToViewportPoint(head.Position)
                if onScreen then
                    local dist = (Vector2.new(pos.X, pos.Y) - center).Magnitude
                    if dist < minScore then
                        minScore = dist
                        closest = head
                    end
                end
            end
        end
    end
    return closest
end

-- MAIN PERFORMANCE LOOP
runService.Heartbeat:Connect(function()
    if not isEnabled then return end
    
    -- Update FOV Circle Position
    fovCircle.Position = Vector2.new(camera.ViewportSize.X / 2, camera.ViewportSize.Y / 2)
    fovCircle.Radius = fovRadius
    
    local target = getTarget()
    if target then
        -- Use a cleaner Lerp that doesn't fight the game engine
        local lookAt = CFrame.new(camera.CFrame.Position, target.Position)
        camera.CFrame = camera.CFrame:Lerp(lookAt, smoothing)
    end
end)
