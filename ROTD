local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
   Name = "ULTIMATE V12.8",
   LoadingTitle = "Ex3cuting Full Build...",
   LoadingSubtitle = "Made By Ori",
   Theme = "Amethyst",
   ConfigurationSaving = { 
      Enabled = true, 
      FolderName = "V12_Configs", 
      FileName = "CombatMaster" 
   },
   KeybindSource = Enum.KeyCode.X 
})

-- [[ SHARED CONFIG ]]
local replicatedStorage = game:GetService("ReplicatedStorage")
local players = game:GetService("Players")
local runService = game:GetService("RunService")
local player = players.LocalPlayer
local camera = workspace.CurrentCamera

-- Attempt to get DataModule
local DataModule = require(player:WaitForChild("DataModule", 30))

_G.SilentAimEnabled = false
_G.AimbotEnabled = false
_G.AutoReload = false
_G.InfAmmo = false 
_G.ShowFOV = false
_G.TPBehind = false
_G.TPDist = 5

local weapon = "ak47"
local globalFOV = 150
local globalDist = 600
local smoothing = 0.5
local FIRE_RATE = 0.1
local cd = 0
local lastBuy = 0

-- [[ AMMO DATA & SELECTION ]]
local ammoIDs = {
    ["p250"] = "#1", ["tec-9"] = "#976", ["XM1014"] = "#9", ["MP5"] = "#40", 
    ["Sawed-off"] = "#70", ["MP7"] = "#147", ["AK-47"] = "#322", ["M4A4"] = "#193", 
    ["Flamethrower"] = "#939", ["AWP"] = "#367", ["Minigun"] = "#416", 
    ["Tactical Bow"] = "#797", ["Dual P250"] = "#886",
    ["Grenade Launcher"] = "#1064", ["Revolver 454"] = "#1110"
}

local selectedAmmo = {}
for name, _ in pairs(ammoIDs) do selectedAmmo[name] = true end

local shopNames = {
    "Shop_Sundays", "Shop_Warehouse", "Shop_Underbridge", 
    "Shop_TrainStation", "Shop_Residentials"
}

-- [[ WEAPON COLLECTION ]]
local weapons = {}
local prefabs = replicatedStorage:FindFirstChild("Prefabs")
if prefabs and prefabs.Items then
    for _, v in pairs(prefabs.Items:GetChildren()) do
        if v:FindFirstChild("Barral") or v:FindFirstChild("Barrel") then
            table.insert(weapons, v.Name)
        end
    end
end
table.sort(weapons)

-- [[ TABS ]]
local CombatTab = Window:CreateTab("Combat", 4483362458)
local QOLTab = Window:CreateTab("QOL", 4483345998)
local VisualsTab = Window:CreateTab("Visuals", 4483345998)
local ConfigTab = Window:CreateTab("Settings", 4483362458)

-- [[ COMBAT TAB ]]
CombatTab:CreateSection("— Silent Aim —")
local SilentAimToggle = CombatTab:CreateToggle({
   Name = "Enable Silent Aim",
   CurrentValue = false,
   Flag = "SilentAim_Tog",
   Callback = function(v) _G.SilentAimEnabled = v end,
})

CombatTab:CreateKeybind({
   Name = "Silent Aim Keybind",
   CurrentKeybind = "Q",
   Flag = "SA_Key",
   Callback = function() SilentAimToggle:Set(not _G.SilentAimEnabled) end,
})

CombatTab:CreateDropdown({
   Name = "Select Weapon",
   Options = weapons,
   CurrentOption = {weapons[1] or "ak47"},
   MultipleOptions = false,
   Flag = "SelectedWeapon", -- THIS ALLOWS SAVING
   Callback = function(Option) weapon = Option[1] end,
})

CombatTab:CreateSection("— Range & FOV (Global) —")
CombatTab:CreateSlider({
   Name = "FOV Radius",
   Range = {10, 800},
   Increment = 10,
   CurrentValue = 150,
   Flag = "FOVRadiusSlider",
   Callback = function(v) globalFOV = v end,
})

CombatTab:CreateSlider({
   Name = "Max Distance",
   Range = {50, 2000},
   Increment = 50,
   CurrentValue = 600,
   Flag = "MaxDistSlider",
   Callback = function(v) globalDist = v end,
})

CombatTab:CreateSection("— Aimbot —")
local AimbotToggle = CombatTab:CreateToggle({
   Name = "Enable Aimbot",
   CurrentValue = false,
   Flag = "Aimbot_Tog",
   Callback = function(v) _G.AimbotEnabled = v end,
})

CombatTab:CreateKeybind({
   Name = "Aimbot Keybind",
   CurrentKeybind = "E",
   Flag = "AB_Key",
   Callback = function() AimbotToggle:Set(not _G.AimbotEnabled) end,
})

CombatTab:CreateSlider({
   Name = "Aimbot Smoothness",
   Range = {1, 10},
   Increment = 1,
   CurrentValue = 5,
   Flag = "SmoothSlider",
   Callback = function(v) smoothing = v / 10 end,
})

CombatTab:CreateSection("— Movement —")
CombatTab:CreateToggle({
   Name = "TP Behind Zombie",
   CurrentValue = false,
   Flag = "TP_Tog",
   Callback = function(v) _G.TPBehind = v end,
})
CombatTab:CreateSlider({
   Name = "TP Distance",
   Range = {2, 15},
   Increment = 1,
   CurrentValue = 5,
   Flag = "TPDistSlider",
   Callback = function(v) _G.TPDist = v end,
})

-- [[ QOL TAB ]]
QOLTab:CreateSection("Ammo Mods")
QOLTab:CreateToggle({
    Name = "Infinite Ammo (Override)", 
    CurrentValue = false, 
    Flag = "InfAmmo_Tog",
    Callback = function(v) _G.InfAmmo = v end
})

QOLTab:CreateToggle({
    Name = "Auto-Buy Ammo", 
    CurrentValue = false, 
    Flag = "AutoBuy_Tog",
    Callback = function(v) _G.AutoReload = v end
})
local BuyStatus = QOLTab:CreateLabel("Status: Idle")

QOLTab:CreateSection("Ammo Selection")
QOLTab:CreateButton({
    Name = "Select All Ammo",
    Callback = function()
        for name, _ in pairs(ammoIDs) do selectedAmmo[name] = true end
        Rayfield:Notify({Title = "Ammo", Content = "All types enabled", Duration = 2})
    end,
})

QOLTab:CreateButton({
    Name = "Deselect All Ammo",
    Callback = function()
        for name, _ in pairs(ammoIDs) do selectedAmmo[name] = false end
        Rayfield:Notify({Title = "Ammo", Content = "All types disabled", Duration = 2})
    end,
})

-- [[ VISUALS TAB ]]
VisualsTab:CreateSection("World Visuals")
VisualsTab:CreateToggle({
    Name = "Show FOV Circle", 
    CurrentValue = false, 
    Flag = "ShowFOV_Tog",
    Callback = function(v) _G.ShowFOV = v end
})

-- [[ CONFIG TAB ]]
ConfigTab:CreateSection("Configuration Management")
ConfigTab:CreateParagraph({Title = "How to Save", Content = "Rayfield saves Toggles and Sliders automatically. Use the button below to force a save of your weapon choice."})

ConfigTab:CreateButton({
    Name = "Save Current Config",
    Callback = function()
        Rayfield:Notify({Title = "Saved!", Content = "Your weapon and combat settings are now locked.", Duration = 3})
    end,
})

-- [[ ENGINE ]]
local FovCircle = Drawing.new("Circle")
FovCircle.Color, FovCircle.Thickness = Color3.fromRGB(150, 100, 255), 1

-- PATCHED AMMO OVERRIDE LOGIC
task.spawn(function()
    while true do
        task.wait(0.01)
        if _G.InfAmmo and DataModule then
            pcall(function()
                setthreadidentity(2)
                local charData = DataModule:GetModCharacter()
                if charData and charData.EquippedItem then
                    local item = charData.EquippedItem
                    local id = item.ID
                    local itemClass = DataModule:GetItemClass(id)
                    local props = itemClass.Properties
                    local realProps = DataModule.GetItemById(id).Values
                    
                    realProps.A = realProps.MA
                    props.Ammo = props.MaxAmmo
                end
                setthreadidentity(8)
            end)
        end
    end
end)

local function GetNearestShop()
    local nearest = nil
    local lastDist = math.huge
    local interact = workspace:FindFirstChild("Interactables")
    if not interact then return nil end
    
    for _, name in pairs(shopNames) do
        local shop = interact:FindFirstChild(name)
        if shop and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local dist = (player.Character.HumanoidRootPart.Position - shop.Position).Magnitude
            if dist < lastDist then lastDist = dist; nearest = shop end
        end
    end
    return nearest
end

runService.RenderStepped:Connect(function(delta)
    local center = Vector2.new(camera.ViewportSize.X / 2, camera.ViewportSize.Y / 2)
    FovCircle.Visible = _G.ShowFOV; FovCircle.Radius = globalFOV; FovCircle.Position = center

    local char = player.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return end

    -- Auto-Buy Logic
    if _G.AutoReload and tick() - lastBuy > 3 then
        lastBuy = tick()
        task.spawn(function()
            local shop = GetNearestShop()
            if not shop then BuyStatus:Set("Status: No Shop Nearby") return end

            for name, id in pairs(ammoIDs) do
                if not _G.AutoReload then break end
                if selectedAmmo[name] then
                    BuyStatus:Set("Buying: " .. name)
                    pcall(function() 
                        replicatedStorage.Library.RemotesManager.ShopService:InvokeServer("buyammo", { StoreObj = shop }, id) 
                    end)
                    task.wait(0.1)
                end
            end
            BuyStatus:Set("Status: Waiting...")
        end)
    end

    cd = math.max(0, cd - delta)
    local gun = char:FindFirstChild(weapon)
    local entities = workspace:FindFirstChild("Entity")
    if not entities then return end

    local target, minScore = nil, math.huge
    for _, v in pairs(entities:GetChildren()) do
        local t = v:FindFirstChild("Head") or v:FindFirstChild("HumanoidRootPart")
        local h = v:FindFirstChildOfClass("Humanoid") or v:FindFirstChild("Zombie")
        if t and h and h.Health > 0 then
            local dist = (char.HumanoidRootPart.Position - t.Position).Magnitude
            local screenPos, onScreen = camera:WorldToViewportPoint(t.Position)
            local mouseDist = (Vector2.new(screenPos.X, screenPos.Y) - center).Magnitude

            if onScreen and dist < globalDist and mouseDist < globalFOV then
                if mouseDist < minScore then minScore, target = mouseDist, t end
            end
        end
    end

    if target then
        if _G.TPBehind and target.Parent then
            local zRoot = target.Parent:FindFirstChild("HumanoidRootPart")
            if zRoot then
                local backPos = zRoot.CFrame * CFrame.new(0, 0, _G.TPDist)
                char.HumanoidRootPart.CFrame = CFrame.lookAt(backPos.p, zRoot.Position)
            end
        end
        if _G.AimbotEnabled then
            camera.CFrame = camera.CFrame:Lerp(CFrame.new(camera.CFrame.Position, target.Position), smoothing)
        end
        if _G.SilentAimEnabled and gun and cd <= 0 then
            replicatedStorage.Library.RemotesManager.PrimaryFire:FireServer("#1", gun, {
                ["ShotPoint"] = char.HumanoidRootPart.Position, ["Direction"] = (target.Position - char.HumanoidRootPart.Position).Unit, 
                ["AmmoData"] = {["MaxAmmo"] = 0, ["Ammo"] = 0}, ["TracerColor"] = Color3.new(0.6, 0.4, 1),
                ["ShotId"] = math.random(1, 9999), ["HitInfoList"] = {{["Part"] = target, ["Position"] = target.Position, ["Normal"] = Vector3.new(0,1,0)}},
                ["ShotOrigin"] = gun.Handle.BulletOrigin, ["Victims"] = {{["Humanoid"] = target.Parent:FindFirstChildOfClass("Humanoid"), ["Object"] = target}},
                ["TargetPoints"] = {target.Position}
            })
            cd = FIRE_RATE
        end
    end
end)
